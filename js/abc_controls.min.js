var playingNow=0,abcStopped=0,mp3Available=1,ABCTuneName="tune",ABCheader=/^([A-Za-z]):\s*(.*)$/,ABCPosition={Ptr:0},lastpButton,ABCCurrentTime=0,ABCduration=0,IntervalHandle,ABCLocation,ABCdurationP,inst=new Instrument("string");
function createABCplayer(c){var b;b='<form onsubmit="return false" oninput="level.value = flevel.valueAsNumber">  <div class="audioplayer">'+('      <button id="pButton'+c+'" class="playButton"')+('          onclick="playABC(ABC'+c+", pButton"+c+", playPosition"+c+", RS"+c+".value, APos"+c+" , Dur"+c+')">')+('          <div id="APos'+c+'" class="audioPos"></div>')+('          <div id="Dur'+c+'" class="durationP"></div>')+"      </button>"+('      <input name="playPosition'+c+'" id="playPosition'+
c+'" type="range" class="audio_control" min="0" max="500" value="0"')+'          oninput="setABCPosition(value/100)" />      <div class="speed_control">';b=b+('          <input name="flevel" id="RS'+c+'" type="range" min="50" max="120" value="100"')+('              onchange="changeABCspeed(ABC'+c+", pButton"+c+', value)">')+'          <output name="level">100</output>%      </div>';b+='      <div class="loop_control">';b+="          <p><small>Playing the <i>dots</i>!</small></p>";b+="      </div>";
b+='      <p class="clear"> </p>';b+="  </div>";return b+="</form>"}
function playABC(c,b,a,f,d,m){CalculateTuneDuration(c,f);var r=getABCheaderValue("L:",c.value);r||(r="1/8");f/=2*eval(r);lastpButton&&lastpButton!=b&&(lastpButton.className="",lastpButton.className="playButton",setABCPosition(0));lastpButton=b;ABCLocation=d;ABCPosition.Ptr=a;ABCdurationP=m;"playButton"==b.className?(stopABC(c),startABC(c,f),b.className="",b.className="stopButton",ABCdurationP.innerHTML=ABCduration.toFixed(1)):(stopABC(c),d.innerHTML="",ABCdurationP.innerHTML="",b.className="",b.className=
"playButton")}function changeABCspeed(c,b,a){CalculateTuneDuration(c,a);var f;(f=getABCheaderValue("L:",c.value))||(f="1/8");f=a/(2*eval(f));CalculateTuneDuration(c,a);"stopButton"==b.className?(stopABC(c),b.className="",b.className="stopButton",setABCPosition(0),ABCCurrentTime=0,startABC(c,f)):(stopABC(c),b.className="",b.className="playButton")}
function CalculateTuneDuration(c,b){var a=c.value.replace(/:\|/g,"|"),a=a.replace(/\|:/g,"|");a.replace(/::/g,"|");var a=a.replace(/\|+/g,"|"),a=a.split("|").length,a=8*Math.round(a/8),f=getABCheaderValue("M:",c.value);"C"==f&&(f="4/4");"C|"==f&&(f="2/2");var d=getABCheaderValue("L:",c.value);d||(d="1/8");ABCduration=a*eval(f)*16*eval(d)*60/b}
function getABCheaderValue(c,b){var a=new RegExp(c),f=b.split("\n"),d="",m;for(m=0;m<f.length;m+=1)if(f[m].match(a)){d=f[m].replace(a,"");d=d.replace(/^\s+|\s+$/g,"");break}return d}function startABC(c,b){playingNow=1;abcStopped=0;inst.silence();inst.play({tempo:b},c.value,function(){playingNow=0;loopABCTune(c,b)});setABCPosition(0);ABCCurrentTime=0;ABCtimer()}function stopABC(c){clearInterval(IntervalHandle);abcStopped=1;inst.silence();setABCPosition(0)}
function loopABCTune(c,b){inst.silence();clearInterval(IntervalHandle);0==playingNow&&0==abcStopped&&(startABC(c,b),setABCPosition(0),ABCCurrentTime=0)}function ABCtimer(){IntervalHandle=setInterval(nudgeABCSlider,100)}function nudgeABCSlider(){ABCCurrentTime+=.1;ABCPosition.Ptr.value=ABCCurrentTime/ABCduration*500;ABCLocation.innerHTML=ABCCurrentTime.toFixed(1)}function setABCPosition(c){ABCPosition.Ptr.value=c}
function preProcessABC(c){var b=c.split("\n"),a,f,d=c="";for(a=0;a<b.length;++a)(f=ABCheader.exec(b[a]))?c+=b[a]+"\n":/^\s*(?:%.*)?$/.test(b[a])||(d+=b[a]);a=/\|1/g;var m=/\|2/g,r=/\|:/g,t=/:\|/g,u=/\|\|/g,v=/\|/g,w=/\[1/g,x=/\[2/g,y=/\|\]/g,e,q=[],z=[],A=[],B=[],C=[],D=[];f=[];for(var n=[],l=0,h=[],p=[],k=e=0,g=0,k=g=0,b="";null!=(e=v.exec(d));)q.push(e.index);f[l]="fb";6<q[0]&&(q[0]=0);for(n[l++]=q[0];null!=((e=a.exec(d))||(e=w.exec(d)));)z.push(e.index),f[l]="fe",n[l++]=e.index;for(;null!=((e=
m.exec(d))||(e=x.exec(d)));)A.push(e.index),f[l]="se",n[l++]=e.index;for(;null!=(e=t.exec(d));)C.push(e.index),f[l]="rr",n[l++]=e.index;for(;null!=(e=r.exec(d));)B.push(e.index),f[l]="lr",n[l++]=e.index;for(;null!=((e=u.exec(d))||(e=y.exec(d)));)D.push(e.index),f[l]="db",n[l++]=e.index;f[l]="lb";n[l++]=q[q.length-1];m=n.map(function(a,b){return b});m.sort(function(a,b){return n[a]-n[b]});for(a=0;a<n.length;a++)h[a]=f[m[a]],p[a]=n[m[a]];for(k=e=0;k<h.length&&!(1E3<b.length);k++)if("rr"==h[k]||"se"==
h[k])for(b+=d.substr(e,p[k]-e),g=k-1;0<=g;g--)if("se"==h[g]||"rr"==h[g]||"fb"==h[g]||"lr"==h[g]){e=p[g];for(a=g+1;a<h.length;a++)if("fe"==h[a]||"rr"==h[a]){b+=d.substr(e,p[a]-e);e=p[a];k=a+1;if("fe"==h[a])for(g=a;g<h.length;g++)if("se"==h[g]){for(k=g;k<h.length;k++)if("db"==h[k]){b+=d.substr(p[g],p[k]-p[g]);e=p[k];k+=1;break}k=g+1;break}break}break}b+=d.substr(e,p[h.length-1]-e);b+='"';d="";for(a=0;a<b.length;a++)'"'==b[a]&&(d=[b.slice(0,a),'\\"',b.slice(a)].join("")),d=d.substring(0,d.length-3);
return c+d};
