var playingNow=0,abcStopped=0,mp3Available=1,ABCTuneName="tune",ABCheader=/^([A-Za-z]):\s*(.*)$/,ABCPosition={Ptr:0},lastpButton,ABCCurrentTime=0,ABCduration=0,IntervalHandle,ABCLocation,ABCdurationP,inst=new Instrument("string");
function createABCplayer(c){var b;b='<form onsubmit="return false" oninput="level.value = flevel.valueAsNumber">  <div class="audioplayer">'+('      <button id="pButton'+c+'" class="playButton"')+('          onclick="playABC(ABC'+c+", pButton"+c+", playPosition"+c+", RS"+c+".value, APos"+c+" , Dur"+c+')">')+('          <div id="APos'+c+'" class="audioPos"></div>')+('          <div id="Dur'+c+'" class="durationP"></div>')+"      </button>"+('      <input name="playPosition'+c+'" id="playPosition'+
c+'" type="range" class="audio_control" min="0" max="500" value="0"')+'          oninput="setABCPosition(value/100)" />      <div class="speed_control">';b=b+('          <input name="flevel" id="RS'+c+'" type="range" min="50" max="120" value="100"')+('              onchange="changeABCspeed(ABC'+c+", pButton"+c+', value)">')+'          <output name="level">100</output>%      </div>';b+='      <div class="loop_control">';b+="          <p><small>Playing the <i>dots</i>!</small></p>";b+="      </div>";
b+='      <p class="clear"> </p>';b+="  </div>";return b+="</form>"}
function playABC(c,b,a,e,f,m){CalculateTuneDuration(c,e);var r=getABCheaderValue("L:",c.value);r||(r="1/8");e/=2*eval(r);lastpButton&&lastpButton!=b&&(lastpButton.className="",lastpButton.className="playButton",setABCPosition(0));lastpButton=b;ABCLocation=f;ABCPosition.Ptr=a;ABCdurationP=m;"playButton"==b.className?(stopABC(c),startABC(c,e),b.className="",b.className="stopButton",ABCdurationP.innerHTML=ABCduration.toFixed(1)):(stopABC(c),f.innerHTML="",ABCdurationP.innerHTML="",b.className="",b.className=
"playButton")}function changeABCspeed(c,b,a){CalculateTuneDuration(c,a);var e;(e=getABCheaderValue("L:",c.value))||(e="1/8");e=a/(2*eval(e));CalculateTuneDuration(c,a);"stopButton"==b.className?(stopABC(c),b.className="",b.className="stopButton",setABCPosition(0),ABCCurrentTime=0,startABC(c,e)):(stopABC(c),b.className="",b.className="playButton")}
function CalculateTuneDuration(c,b){var a=c.value.replace(/:\|/g,"|"),a=a.replace(/\|:/g,"|");a.replace(/::/g,"|");var a=a.replace(/\|+/g,"|"),a=a.split("|").length,a=8*Math.round(a/8),e=getABCheaderValue("M:",c.value);"C"==e&&(e="4/4");"C|"==e&&(e="2/2");var f=getABCheaderValue("L:",c.value);f||(f="1/8");ABCduration=a*eval(e)*16*eval(f)*60/b}
function getABCheaderValue(c,b){var a=new RegExp("^"+c),e=b.split("\n"),f="",m;for(m=0;m<e.length;m+=1)if(e[m].match(a)){a=new RegExp(c+"\\s+");f=e[m].replace(a,"");break}return f}function startABC(c,b){playingNow=1;abcStopped=0;inst.silence();inst.play({tempo:b},c.value,function(){playingNow=0;loopABCTune(c,b)});setABCPosition(0);ABCCurrentTime=0;ABCtimer()}function stopABC(c){clearInterval(IntervalHandle);abcStopped=1;inst.silence();setABCPosition(0)}
function loopABCTune(c,b){inst.silence();clearInterval(IntervalHandle);0==playingNow&&0==abcStopped&&(startABC(c,b),setABCPosition(0),ABCCurrentTime=0)}function ABCtimer(){IntervalHandle=setInterval(nudgeABCSlider,100)}function nudgeABCSlider(){ABCCurrentTime+=.1;ABCPosition.Ptr.value=ABCCurrentTime/ABCduration*500;ABCLocation.innerHTML=ABCCurrentTime.toFixed(1)}function setABCPosition(c){ABCPosition.Ptr.value=c}
function preProcessABC(c){var b=c.split("\n"),a,e,f=c="";for(a=0;a<b.length;++a)(e=ABCheader.exec(b[a]))?c+=b[a]+"\n":/^\s*(?:%.*)?$/.test(b[a])||(f+=b[a]);a=/\|1/g;var m=/\|2/g,r=/\|:/g,t=/:\|/g,u=/\|\|/g,v=/\|/g,w=/\[1/g,x=/\[2/g,y=/\|\]/g,d,q=[],z=[],A=[],B=[],C=[],D=[];e=[];for(var n=[],l=0,h=[],p=[],k=d=0,g=0,k=g=0,b="";null!=(d=v.exec(f));)q.push(d.index);e[l]="fb";6<q[0]&&(q[0]=0);for(n[l++]=q[0];null!=((d=a.exec(f))||(d=w.exec(f)));)z.push(d.index),e[l]="fe",n[l++]=d.index;for(;null!=((d=
m.exec(f))||(d=x.exec(f)));)A.push(d.index),e[l]="se",n[l++]=d.index;for(;null!=(d=t.exec(f));)C.push(d.index),e[l]="rr",n[l++]=d.index;for(;null!=(d=r.exec(f));)B.push(d.index),e[l]="lr",n[l++]=d.index;for(;null!=((d=u.exec(f))||(d=y.exec(f)));)D.push(d.index),e[l]="db",n[l++]=d.index;e[l]="lb";n[l++]=q[q.length-1];m=n.map(function(a,b){return b});m.sort(function(a,b){return n[a]-n[b]});for(a=0;a<n.length;a++)h[a]=e[m[a]],p[a]=n[m[a]];for(k=d=0;k<h.length&&!(1E3<b.length);k++)if("rr"==h[k]||"se"==
h[k])for(b+=f.substr(d,p[k]-d),g=k-1;0<=g;g--)if("se"==h[g]||"rr"==h[g]||"fb"==h[g]||"lr"==h[g]){d=p[g];for(a=g+1;a<h.length;a++)if("fe"==h[a]||"rr"==h[a]){b+=f.substr(d,p[a]-d);d=p[a];k=a+1;if("fe"==h[a])for(g=a;g<h.length;g++)if("se"==h[g]){for(k=g;k<h.length;k++)if("db"==h[k]){b+=f.substr(p[g],p[k]-p[g]);d=p[k];k+=1;break}k=g+1;break}break}break}b+=f.substr(d,p[h.length-1]-d);b+='"';f="";for(a=0;a<b.length;a++)'"'==b[a]&&(f=[b.slice(0,a),'\\"',b.slice(a)].join("")),f=f.substring(0,f.length-3);
return c+f};
